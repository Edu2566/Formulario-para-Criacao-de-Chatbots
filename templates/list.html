{% extends "base.html" %}
{% block title %}Chatbots - Lista{% endblock %}

{% macro render_tree(messages) %}
  <ol class="space-y-2 border-l border-slate-800/70 pl-3">
    {% for message in messages %}
      <li class="pl-2">
        <div class="flex items-start gap-2">
          <span class="w-2 h-2 rounded-full mt-2 bg-aurora/60"></span>
          <span class="text-sm text-slate-100">{{ message.content|replace('\n','<br>')|safe }}</span>
        </div>
        {% if message.children %}
          {{ render_tree(message.children) }}
        {% endif %}
      </li>
    {% endfor %}
  </ol>
{% endmacro %}

{% block content %}
<div class="flex items-center justify-between flex-wrap gap-3 mb-6">
  <div>
    <p class="text-sm text-aurora font-semibold uppercase tracking-[0.2em]">Chatbots</p>
    <h2 class="text-2xl font-display font-semibold">Lista e visão escrita</h2>
    <p class="text-sm text-slate-300">Gerencie e visualize rapidamente a estrutura textual de cada chatbot. Use os botões para editar ou deletar.</p>
  </div>
  <div class="flex items-center gap-2">
    <a href="{{ url_for('main.maps_view') }}" class="px-4 py-2 rounded-xl bg-slate-800 text-slate-200 border border-slate-700 hover:border-aurora/40 hover:text-aurora transition text-sm font-semibold">Ver mapas mentais</a>
    <a href="{{ url_for('builder.chatbot_form') }}" class="px-4 py-2 rounded-xl bg-gradient-to-r from-aurora to-peach text-slate-900 font-semibold shadow-lg shadow-peach/20 hover:shadow-peach/30 transition text-sm">Novo chatbot</a>
  </div>
</div>

{% if not chatbots %}
  <div class="bg-white/5 border border-white/10 rounded-2xl px-4 py-5 text-slate-300">Nenhum chatbot criado ainda. Clique em “Novo chatbot” para começar.</div>
{% else %}
  <div class="grid gap-4 md:grid-cols-2">
    {% for bot in chatbots %}
      <article class="bg-white/5 border border-white/10 rounded-2xl p-5 space-y-4 shadow-lg shadow-black/20">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-aurora font-semibold">Chatbot</p>
            <h4 class="text-lg font-display font-semibold">{{ bot.name }}</h4>
            <p class="text-xs text-slate-400">{{ bot.created_at.strftime("%d/%m/%Y %H:%M") if bot.created_at else "" }}</p>
          </div>
          <div class="flex items-center gap-2">
            <a href="{{ url_for('export.export_map_pdf', bot_id=bot.id) }}"
               class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-800 text-slate-200 border border-slate-700 hover:border-aurora/40 hover:text-aurora transition">Exportar PDF</a>
            <a href="{{ url_for('builder.edit_chatbot', bot_id=bot.id) }}"
               class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-aurora/15 text-aurora border border-aurora/30 hover:bg-aurora/25 transition">Editar</a>
            <form method="POST" action="{{ url_for('builder.delete_chatbot', bot_id=bot.id) }}"
                  onsubmit="return confirm('Tem certeza que deseja remover {{ bot.name }}?');">
              <button type="submit"
                      class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-rose-500/15 text-rose-200 border border-rose-400/30 hover:bg-rose-500/25 transition">
                Deletar
              </button>
            </form>
          </div>
        </div>
        {% if bot.description %}
          <p class="text-sm text-slate-300">{{ bot.description }}</p>
        {% endif %}
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400 mb-1">Mensagens (escrito)</p>
          {% if bot.root_messages %}
            {{ render_tree(bot.root_messages) }}
          {% else %}
            <p class="text-sm text-slate-500">Nenhuma mensagem cadastrada.</p>
          {% endif %}
        </div>
      </article>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}
